{"version":3,"file":"Room.ext.js","sources":["../src/Room.ext.ts"],"sourcesContent":["/**\n * Room.ts augmentations\n * Monkey-patches some Room methods to improve the testing experience.\n */\n\nimport { Deferred, Room, Client } from \"@colyseus/core\";\nimport { Room as ClientRoom } from \"colyseus.js\";\n\n// import timers from \"timers/promises\";\n\n// ----------------------------------------------------------------------------------------\n// SERVER-SIDE EXTENSIONS\n// ----------------------------------------------------------------------------------------\n\ndeclare module \"@colyseus/core\" {\n  interface Room {\n    waitForMessage(messageType: string): Promise<[Client, any]>;\n    waitForNextMessage(additionalDelay?: number): Promise<void>;\n    waitForNextPatch(): Promise<void>;\n    waitForNextSimulationTick(): Promise<void>;\n    _waitingForMessage: [number, Deferred];\n    _waitingForPatch: [number, Deferred];\n  }\n}\n\n/*\n * Wait until receive message\n */\nconst _originalOnMessage = Room.prototype['_onMessage'];\nRoom.prototype['_onMessage'] = function(this: Room) {\n  _originalOnMessage.apply(this, arguments);\n  if (this._waitingForMessage) {\n    setTimeout(() => this._waitingForMessage[1].resolve(), this._waitingForMessage[0]);\n  }\n};\nRoom.prototype.waitForNextMessage = async function(this: Room, additionalDelay: number = 0) {\n  this._waitingForMessage = [additionalDelay, new Deferred()];\n  return this._waitingForMessage[1];\n}\n\nRoom.prototype.waitForMessage = async function(this: Room, type: string, rejectTimeout: number = 3000) {\n  const originalMessageHandler = this['onMessageHandlers'][type] || (() => {});\n  const room = this;\n\n  return new Promise((resolve, reject) => {\n    const rejectionTimeout = setTimeout(() => reject(new Error(`message '${type}' was not called. timed out (${rejectTimeout}ms)`)), rejectTimeout);\n\n    room['onMessageHandlers'][type] = async function (client, message) {\n      // clear rejection timeout\n      clearTimeout(rejectionTimeout);\n\n      // call original handler\n      await originalMessageHandler.apply(room, arguments);\n\n      // revert to original message handler\n      room['onMessageHandlers'][type] = originalMessageHandler;\n\n      // resolves waitForMessage promise.\n      resolve([client, message]);\n    }\n  });\n}\n\n/**\n * Wait next simulation tick\n */\nRoom.prototype.waitForNextSimulationTick = async function(this: Room) {\n  if (this['_simulationInterval']) {\n    const milliseconds = this['_simulationInterval']['_idleTimeout'];\n    return new Promise((resolve) => setTimeout(resolve, milliseconds));\n    // return timers.setTimeout(milliseconds);\n\n  } else {\n    console.warn(\"⚠️ waitForSimulation() - .setSimulationInterval() is a must.\");\n    return Promise.resolve();\n  }\n}\n\n/**\n * Wait for next patch\n */\nconst _originalBroadcastPatch = Room.prototype['broadcastPatch'];\nRoom.prototype['broadcastPatch'] = function(this: Room) {\n  const retVal = _originalBroadcastPatch.apply(this, arguments);\n  if (this._waitingForPatch) {\n    setTimeout(() => this._waitingForPatch[1].resolve(), this._waitingForPatch[0]);\n  }\n  return retVal;\n};\nRoom.prototype.waitForNextPatch = async function (this: Room, additionalDelay: number = 0) {\n  this._waitingForPatch = [additionalDelay, new Deferred()];\n  return this._waitingForPatch[1];\n}\n\n// ----------------------------------------------------------------------------------------\n// CLIENT-SIDE EXTENSIONS\n// ----------------------------------------------------------------------------------------\n\ndeclare module \"colyseus.js\" {\n  interface Room {\n    waitForMessage(messageType: string, rejectTimeout?: number): Promise<any>;\n    waitForNextMessage(additionalDelay?: number): Promise<[string, any]>;\n    waitForNextPatch(): Promise<void>;\n    _waitingForMessage: [number, Deferred];\n    _waitingForPatch: [number, Deferred];\n  }\n}\n\nClientRoom.prototype.waitForMessage = async function(this: Room, type: string, rejectTimeout: number = 3000) {\n  return new Promise((resolve, reject) => {\n    const received = (message) => {\n      unbind();\n      resolve(message);\n      clearTimeout(rejectionTimeout);\n    }\n    const unbind = this['onMessageHandlers'].on(type, (message) => received(message));\n\n    const rejectionTimeout = setTimeout(() => {\n      unbind();\n      reject(new Error(`message '${type}' was not called. timed out (${rejectTimeout}ms)`));\n    }, rejectTimeout);\n  });\n}\n\nconst _originalClientOnMessage = ClientRoom.prototype['dispatchMessage'];\nClientRoom.prototype['dispatchMessage'] = function(this: ClientRoom) {\n  _originalClientOnMessage.apply(this, arguments);\n  if (this._waitingForMessage) {\n    setTimeout(() => {\n      this._waitingForMessage[1].resolve([arguments[0], arguments[1]]);\n    }, this._waitingForMessage[0]);\n  }\n};\nClientRoom.prototype.waitForNextMessage = async function(this: Room, additionalDelay: number = 0) {\n  this._waitingForMessage = [additionalDelay, new Deferred()];\n  return this._waitingForMessage[1];\n}\n\nconst _originalClientPatch = ClientRoom.prototype['patch'];\nClientRoom.prototype['patch'] = function(this: ClientRoom) {\n  _originalClientPatch.apply(this, arguments);\n  if (this._waitingForPatch) {\n    setTimeout(() => {\n      this._waitingForPatch[1].resolve([arguments[0], arguments[1]]);\n    }, this._waitingForPatch[0]);\n  }\n};\nClientRoom.prototype.waitForNextPatch = async function(this: ClientRoom, additionalDelay: number = 0) {\n  this._waitingForPatch = [additionalDelay, new Deferred()];\n  return this._waitingForPatch[1];\n}"],"names":["Room","Deferred","ClientRoom"],"mappings":"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"}